name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    environment:
      name: production-frontend
      url: https://aquabeacon-client-hrb49xvuu-tornado-techies-projects.vercel.app
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Frontend Deployment Info
        run: |
          echo "ðŸš€ Frontend deployment triggered"
          echo "ðŸ“‹ Commit: ${{ github.sha }}"
          echo "ðŸ“ Message: ${{ github.event.head_commit.message }}"
          echo "ðŸ‘¤ Author: ${{ github.actor }}"
          echo "ðŸ• Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ðŸŒ Vercel Deployment:"
          echo "â€¢ URL: https://aquabeacon-client-hrb49xvuu-tornado-techies-projects.vercel.app"
          echo "â€¢ Platform: vercel"
          echo "â€¢ Framework: vite-react"
          echo "â€¢ Environment: production-frontend"
          echo "â€¢ Branch: main"
          echo "â€¢ Auto-deploy: Enabled"
      
      - name: Wait for Frontend Deployment
        run: |
          echo "â³ Waiting for Vercel deployment..."
          sleep 45
      
      - name: Verify Frontend Deployment
        run: |
          echo "ðŸ” Verifying frontend deployment..."
          
          FRONTEND_URL="https://aquabeacon-client-hrb49xvuu-tornado-techies-projects.vercel.app"
          
          # Test main page
          frontend_status=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" || echo "000")
          
          # Test deployment info endpoint
          deployment_info=$(curl -s "$FRONTEND_URL/deployment-info.json" || echo "not available")
          
          echo "Frontend status: $frontend_status"
          echo "Deployment info: $deployment_info"
          
          if [[ $frontend_status == "200" ]]; then
            echo "âœ… Frontend deployment successful"
          else
            echo "âš ï¸ Frontend status: $frontend_status (may still be deploying)"
          fi

  deploy-backend:
    name: Deploy Backend  
    runs-on: ubuntu-latest
    environment:
      name: production-backend
      url: https://aquabeacon-backend.onrender.com
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Backend Deployment Info
        run: |
          echo "ðŸš€ Backend deployment triggered"
          echo "ðŸ“‹ Commit: ${{ github.sha }}"
          echo "ðŸ• Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "âš¡ Render Deployment:"
          echo "â€¢ URL: https://aquabeacon-backend.onrender.com"
          echo "â€¢ Platform: Render"
          echo "â€¢ Framework: Node.js + Express"
          echo "â€¢ Branch: main"
          echo "â€¢ Auto-deploy: Enabled"
          echo "â€¢ Environment: production-backend"
      
      - name: Wait for Backend Deployment
        run: |
          echo "â³ Waiting for Render deployment..."
          sleep 60
      
      - name: Verify Backend Deployment
        run: |
          echo "ðŸ” Verifying backend deployment..."
          
          BACKEND_URL="https://aquabeacon-backend.onrender.com"
          
          backend_status=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL" || echo "000")
          
          echo "Backend status: $backend_status"
          
          if [[ $backend_status =~ ^(200|404)$ ]]; then
            echo "âœ… Backend deployment successful"
          else
            echo "âš ï¸ Backend status: $backend_status (may still be deploying)"
          fi

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result == 'success' && 'âœ… Success' || 'âš ï¸ Check logs' }} | [Live Site](https://aquabeacon-client-hrb49xvuu-tornado-techies-projects.vercel.app) |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result == 'success' && 'âœ… Success' || 'âš ï¸ Check logs' }} | [API Server](https://aquabeacon-backend.onrender.com) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ **If deployments show issues:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Check Vercel dashboard for build logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify environment variables in deployment platforms" >> $GITHUB_STEP_SUMMARY
          echo "3. Check individual job logs above for detailed status" >> $GITHUB_STEP_SUMMARY
      
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend:** https://aquabeacon-client-hrb49xvuu-tornado-techies-projects.vercel.app" >> $GITHUB_STEP_SUMMARY
          echo "**Backend:** https://aquabeacon-backend.onrender.com" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY