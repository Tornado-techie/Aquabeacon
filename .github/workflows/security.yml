name: Security & Maintenance

on:
  schedule:
    # Run security checks daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  # Security audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd server && npm ci
          cd ../client && npm ci
      
      - name: Run npm audit (Backend)
        run: |
          cd server
          npm audit --audit-level moderate --production
      
      - name: Run npm audit (Frontend)
        run: |
          cd client
          npm audit --audit-level moderate --production
      
      - name: Check for outdated packages
        run: |
          echo "Backend outdated packages:"
          cd server && npm outdated || true
          echo "Frontend outdated packages:"
          cd ../client && npm outdated || true

  # Database backup simulation
  backup-check:
    name: Backup Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Simulate backup check
        run: |
          echo "🔄 Checking backup systems..."
          echo "✅ MongoDB Atlas automated backups: Active"
          echo "✅ S3 file storage versioning: Enabled"
          echo "📊 Last backup: $(date)"
          echo "🎯 Retention policy: 30 days"

  # Performance monitoring
  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: API Performance Test
        run: |
          echo "🔍 Testing API response times..."
          
          # Test health endpoint
          start_time=$(date +%s.%3N)
          curl -s https://aquabeacon-api.render.com/health > /dev/null
          end_time=$(date +%s.%3N)
          response_time=$(echo "$end_time - $start_time" | bc -l)
          echo "Health endpoint: ${response_time}s"
          
          # Test frontend load time
          start_time=$(date +%s.%3N)
          curl -s https://aquabeacon.vercel.app > /dev/null
          end_time=$(date +%s.%3N)
          response_time=$(echo "$end_time - $start_time" | bc -l)
          echo "Frontend load: ${response_time}s"
      
      - name: Check disk usage
        run: |
          echo "💾 Disk usage check:"
          df -h || echo "Disk usage check skipped in CI"

  # Dependency updates check
  dependency-updates:
    name: Check for Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Check for security updates
        run: |
          echo "🔍 Checking for security updates..."
          
          cd server
          security_updates=$(npm audit --audit-level high --json | jq '.metadata.vulnerabilities.high + .metadata.vulnerabilities.critical' 2>/dev/null || echo "0")
          echo "Backend security issues: $security_updates"
          
          cd ../client
          security_updates=$(npm audit --audit-level high --json | jq '.metadata.vulnerabilities.high + .metadata.vulnerabilities.critical' 2>/dev/null || echo "0")
          echo "Frontend security issues: $security_updates"