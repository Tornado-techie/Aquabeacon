name: Monitoring

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  health-check:
    name: Service Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Frontend Health Check
        run: |
          echo "ðŸŒ Checking frontend health..."
          
          FRONTEND_URL="https://aquabeacon-client-hrb49xvuu-tornado-techies-projects.vercel.app"
          
          response=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" || echo "000")
          load_time=$(curl -s -o /dev/null -w "%{time_total}" "$FRONTEND_URL" || echo "0")
          
          echo "Frontend status: $response"
          echo "Load time: ${load_time}s"
          
          if [ "$response" = "200" ]; then
            echo "âœ… Frontend is healthy"
            echo "FRONTEND_STATUS=healthy" >> $GITHUB_ENV
          else
            echo "âŒ Frontend issues detected"
            echo "FRONTEND_STATUS=unhealthy" >> $GITHUB_ENV
          fi
          
          echo "FRONTEND_LOAD_TIME=$load_time" >> $GITHUB_ENV
      
      - name: Backend Health Check
        run: |
          echo "âš¡ Checking backend health..."
          
          BACKEND_URL="https://aquabeacon-backend.onrender.com"
          API_URL="https://aquabeacon-backend.onrender.com/api/health"
          
          # Check main backend
          backend_response=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL" || echo "000")
          
          # Check API health endpoint
          api_response=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL" || echo "000")
          api_time=$(curl -s -o /dev/null -w "%{time_total}" "$API_URL" || echo "0")
          
          echo "Backend status: $backend_response"
          echo "API status: $api_response"  
          echo "API response time: ${api_time}s"
          
          if [[ "$backend_response" =~ ^(200|404)$ ]] && [[ "$api_response" =~ ^(200|404)$ ]]; then
            echo "âœ… Backend is healthy"
            echo "BACKEND_STATUS=healthy" >> $GITHUB_ENV
          else
            echo "âŒ Backend issues detected"
            echo "BACKEND_STATUS=unhealthy" >> $GITHUB_ENV
          fi
          
          echo "API_RESPONSE_TIME=$api_time" >> $GITHUB_ENV
      
      - name: Performance Check
        run: |
          echo "ðŸ“Š Performance analysis..."
          
          # Check if response times are acceptable
          if (( $(echo "$FRONTEND_LOAD_TIME < 3.0" | bc -l) )); then
            echo "âœ… Frontend performance: Good (${FRONTEND_LOAD_TIME}s)"
            FRONTEND_PERF="good"
          elif (( $(echo "$FRONTEND_LOAD_TIME < 5.0" | bc -l) )); then
            echo "âš ï¸ Frontend performance: Fair (${FRONTEND_LOAD_TIME}s)"
            FRONTEND_PERF="fair"
          else
            echo "âŒ Frontend performance: Poor (${FRONTEND_LOAD_TIME}s)"
            FRONTEND_PERF="poor"
          fi
          
          if (( $(echo "$API_RESPONSE_TIME < 2.0" | bc -l) )); then
            echo "âœ… API performance: Good (${API_RESPONSE_TIME}s)"
            API_PERF="good"
          elif (( $(echo "$API_RESPONSE_TIME < 4.0" | bc -l) )); then
            echo "âš ï¸ API performance: Fair (${API_RESPONSE_TIME}s)" 
            API_PERF="fair"
          else
            echo "âŒ API performance: Poor (${API_RESPONSE_TIME}s)"
            API_PERF="poor"
          fi
          
          echo "FRONTEND_PERF=$FRONTEND_PERF" >> $GITHUB_ENV
          echo "API_PERF=$API_PERF" >> $GITHUB_ENV
      
      - name: Security Headers Check
        run: |
          echo "ðŸ” Checking security headers..."
          
          FRONTEND_URL="https://aquabeacon-client-hrb49xvuu-tornado-techies-projects.vercel.app"
          
          headers=$(curl -s -I "$FRONTEND_URL" || echo "")
          
          # Check for important security headers
          if echo "$headers" | grep -i "x-frame-options" > /dev/null; then
            echo "âœ… X-Frame-Options header present"
          else
            echo "âš ï¸ X-Frame-Options header missing"
          fi
          
          if echo "$headers" | grep -i "content-security-policy" > /dev/null; then
            echo "âœ… CSP header present"  
          else
            echo "âš ï¸ CSP header missing"
          fi
          
          if echo "$headers" | grep -i "strict-transport-security" > /dev/null; then
            echo "âœ… HSTS header present"
          else
            echo "âš ï¸ HSTS header missing"
          fi
        continue-on-error: true
      
      - name: Create Status Report
        run: |
          echo "## ðŸ” AquaBeacon Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“… Check Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŒ Services Status" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Performance | Load Time |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-------------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | $([[ $FRONTEND_STATUS == 'healthy' ]] && echo 'âœ… Healthy' || echo 'âŒ Issues') | $([[ $FRONTEND_PERF == 'good' ]] && echo 'âœ… Good' || echo 'âš ï¸ '$FRONTEND_PERF) | ${FRONTEND_LOAD_TIME}s |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend API | $([[ $BACKEND_STATUS == 'healthy' ]] && echo 'âœ… Healthy' || echo 'âŒ Issues') | $([[ $API_PERF == 'good' ]] && echo 'âœ… Good' || echo 'âš ï¸ '$API_PERF) | ${API_RESPONSE_TIME}s |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”— Live URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** https://aquabeacon-client-hrb49xvuu-tornado-techies-projects.vercel.app" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend:** https://aquabeacon-backend.onrender.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ $FRONTEND_STATUS == 'healthy' && $BACKEND_STATUS == 'healthy' ]]; then
            echo "âœ… **Overall Status:** All services are healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Overall Status:** Some services need attention" >> $GITHUB_STEP_SUMMARY
          fi